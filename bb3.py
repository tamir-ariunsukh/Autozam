import streamlit as st
import pandas as pd
import plotly.express as px
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
from datetime import datetime
import folium
from streamlit_folium import st_folium
import io
import pandas as pd
import numpy as np
from sklearn.linear_model import LinearRegression, Ridge, Lasso
from sklearn.ensemble import RandomForestRegressor, GradientBoostingRegressor, AdaBoostRegressor, ExtraTreesRegressor
from sklearn.tree import DecisionTreeRegressor
from sklearn.neighbors import KNeighborsRegressor
from sklearn.svm import SVR
from sklearn.neural_network import MLPRegressor
from sklearn.preprocessing import MinMaxScaler
from xgboost import XGBRegressor
from lightgbm import LGBMRegressor
from catboost import CatBoostRegressor
import tensorflow as tf

from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import plotly.express as px


st.set_page_config(page_title="С.Цолмон, А.Тамир нарын судалгаа 2025-06-11", layout="wide")


@st.cache_data
def load_data():
    df = pd.read_excel("output_onehot.xlsx")

    columns = [
        "Дугаар",
        "Газар /Хэлтэс/",
        "Зөрчил гарсан газрын хаяг",
        "Замын байршил /тайлбар/",
        "Дүүргийн нэр",
        "Хорооны дугаар",
        "Аймгийн нэр",
        "Багийн дугаар",
        "Сумын нэр",
        "Уртраг",
        "Өргөрөг",
        "Осол",
        "Зөрчил огноо",
        "Авто зам - Замын хучилт Тодорхойгүй",
        "Авто зам - Замын хучилт Асфальт",
        "Авто зам - Замын хучилт Бетон",
        "Авто зам - Замын хучилт Сайжруулсан",
        "Авто зам - Замын хучилт Хайрган",
        "Авто зам - Замын хучилт Хөрсөн",
        "Авто зам - Замын хучилт Цементэн",
        "Авто зам - Зорчих хэсгийн өргөн",
        "ГБХ: бусад зөрчил",
        "анхаарал болгоомжгүй зөрчил",
        "архидан согтуурсан зөрчил",
        "асран хамгаалагч зөрчил",
        "бусад зөрчил",
        "бэлдмэл хэрэглэсэн этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
        "бүрэн бус тээврийн хэрэгсэл жолоодсон зөрчил",
        "бүх шатны боловсролын/б-ын холбогдох албан тушаалтан 10 хүртэлх насны хүүхдийг харгалзах хүнгүйгээр ЗХ-д оролцуулсан зөрчил",
        "гадны гэрэл хэрэглэх зөрчил",
        "гарамгүй хэсгээр зам хөндлөн гарсан зөрчил",
        "гарц зөрчил",
        "гэрэл дохио зөрчсөн зөрчил",
        "гүйцэд түрүүлэх үйлдэл буруу зөрчил",
        "гүйцэж түрүүлэх үйлдэл буруу хийсэн зөрчил",
        "жолоодох чадваргүй үедээ зорчих хэсгээр явсан зөрчил",
        "жолоодох эрхээ хасуулсан этгээд эрхийн үнэмлэхгүй жолоодсон зөрчил",
        "зам: ЗХ-ний дүрмийг сахин биелүүлээгүй зөрчил",
        "зам: ЗХАБ-ыг хангаж чадахааргүй өвчтэй буюу ядарсан үедээ т/х жолоодож замын хөдөлгөөнд оролцсон зөрчил",
        "зам: ЗХАБ-ын эсрэг гэмт хэрэг зөрчил",
        "зам: Т/х жолоодох эрхгүй (жолоодлогын дадлага хийхээс бусад тохиолдолд) буюу эрхээ хасуулсан этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
        "зам: Эцэг эх зөрчил",
        "зам: гарц зөрчил",
        "зам: замын гэрэлтүүлэг хангалтгүй зөрчил",
        "зам: замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
        "зам: зогсолт зогсоолын журам зөрчсөн зөрчил",
        "зам: ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
        "зам: тэмдэг тэмдэглэл зөрчсөн зөрчил",
        "зам: явган хүний гарц ба гарамтай хэсгийн гарцгүй зөрчил",
        "замын гэрэлтүүлэг хангалтгүй зөрчил",
        "замын нөхцөлөөс зөрчил",
        "замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
        "зан харьцаа зөрчил",
        "зогсолт зогсоолын журам зөрчсөн зөрчил",
        "зогсоох арга хэмжээ аваагүй зөрчил",
        "зөрчлийн талаар холбогдох байгууллагад шуурхай мэдээлээгүй зөрчил",
        "мал хариулгагүй зөрчил",
        "нийтээр дагаж мөрдөх хэм хэмжээ зөрчсөн зөрчил",
        "ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
        "согтуугаар тээврийн хэрэгсэл жолоодсон зөрчил",
        "техникийн гэмтлээс замын нөхцөл байдлаас зөрчил",
        "уулзвар гарц нэвтрэх журам зөрчсөн зөрчил",
        "ухрах үйлдэл буруу хийсэн зөрчил",
        "хажуу хоорондын зай тохируулаагүй зөрчил",
        "хамгаалах бүс хэрэглээгүй зөрчил",
        "хувь хүний ёс суртахууны төлөвшил зөрчил",
        "хурд тохируулаагүй зөрчил",
        "хурд хэтрүүлсэн зөрчил",
        "хяналт шалгалт сул зөрчил",
        "хүн ба ачаа тээвэрлэх журам зөрчсөн зөрчил",
        "эвдэж сүйтгэсэн зөрчил",
        "эгнээ байр буруу эзэлсэн зөрчил",
        "эргэх үйлдэл буруу хийсэн зөрчил",
        "эрхийн үнэмлэхгүй этгээд тээврийн хэрэгсэл жолоодсон зөрчил",
        "эсрэг урсгалд орох зөрчил",
        "эсрэг урсгалд орсон зөрчил",
        "явган хүний гарц ба гарамтай хэсгийн гарцгүй хэсгээр гарсан зөрчил",
        "үүргээ зохих ёсоор биелүүлээгүй зөрчил",
        "өөрийгөө хянаж зөрчил",
        "Дүүрэг",
        "Аймаг",
        "Авто зам - Замын харьяалал Нийслэлийн чанартай авто зам",
        "Авто зам - Замын харьяалал Орон нутгийн чанартай авто зам",
        "Авто зам - Замын харьяалал Иргэн аж ахуйн нэгж, байгууллагын дотоодын зам",
        "Авто зам - Замын харьяалал Улсын чанартай авто зам",
        "Авто зам - Замын харьяалал Хувийн зам",
        "Авто зам - Замын харьяалал Олон улсын чанартай авто зам",
        "Авто зам - Замын харьяалал Тусгай зориулалтын зам",
        "Авто зам - Замын ангилал Хорооллын",
        "Авто зам - Замын ангилал Ердийн",
        "Авто зам - Замын ангилал Тууш",
        "Авто зам - Замын ангилал Хурдны",
        "Авто зам - Замын гадаргуу Хуурай",
        "Авто зам - Замын гадаргуу Мөстэй",
        "Авто зам - Замын гадаргуу Нойтон",
        "Авто зам - Замын гадаргуу Цастай",
        "Авто зам - Замын гадаргуу Эдрэлтэй",
        "Авто зам - Замын гадаргуу Бохирдсон",
        "Авто зам - Замын онцлог Тэгш",
        "Авто зам - Замын онцлог Уруу",
        "Авто зам - Замын онцлог Өгсүүр",
        "Авто зам - Замын онцлог Шулуун",
        "Авто зам - Замын онцлог Хазгай",
        "Авто зам - Замын онцлог Огцом эргэлттэй",
        "Авто зам - Замын онцлог Налуу",
        "Авто зам - Замын онцлог Алсуур эргэлттэй",
        "Авто зам - Үзэгдэх орчин Чөлөөтэй",
        "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэлтүүлэггүй",
        "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэгтүүлэгтэй",
        "Авто зам - Үзэгдэх орчин Хязгаарлагдмал",
        "Авто зам - Үзэгдэх орчин Хангалтгүй",
        "Авто зам - Үзэгдэх орчин Бүрэнхий",
        "Авто зам - Үзэгдэх орчин Саад байсан",
        "Авто зам - Үзэгдэх орчин Манантай",
        "Авто зам - Цаг агаар Таатай",
        "Авто зам - Цаг агаар Үүлэрхэг",
        "Авто зам - Цаг агаар Цастай",
        "Авто зам - Цаг агаар Шуургатай",
        "Авто зам - Цаг агаар Манантай",
        "Авто зам - Цаг агаар Бороотой",
        "Авто зам - Бусад Өдөр",
        "Авто зам - Бусад Суурин газар",
        "Авто зам - Бусад Шөнө",
        "Авто зам - Бусад Суурингийн гаднах",
        "Авто зам - Бусад Аж ахуйн нэгж - Бусад",
        "Авто зам - Бусад Гудамж талбай - бусад",
        "Авто зам - Бусад Бусад газар - Өвөлжөө",
        "Авто зам - Бусад Бусад газар - Хөдөө хээр",
        "Авто зам - Бусад Бусад газар - Бусад",
        "Авто зам - Бусад Гудамж талбай - ил зогсоол",
        "Авто зам - Бусад Гудамж талбай - төмөр зам",
        "Авто зам - Бусад Гудамж талбай - гэр хорооллын гудамж",
        "Авто зам - Бусад Олон нийтийн газар - бөөний худалдааны төв",
        "Авто зам - Бусад Олон нийтийн газар - бусад",
        "Авто зам - Бусад Гудамж талбай - автобусны буудал",
        "Авто зам - Бусад Гудамж талбай - орон сууцны хорооллын гудамж",
        "Авто зам - Бусад эмнэлэг хувийн өмчийн",
        "Авто зам - Бусад Бусад газар - Бэлчээр",
        "Авто зам - Бусад Олон нийтийн газар - авто вокзал",
        "Авто зам - Бусад Бусад газар - Хаваржаа",
        "Авто зам - Бусад Олон нийтийн газар - дэлгүүр",
        "Авто зам - Бусад шатахуун түгээх станц",
        "Авто зам - Бусад Гэр, орон сууц - хувийн байшин",
        "Авто зам - Бусад Бусад газар - Зуслан",
        "Авто зам - Бусад Бусад газар - Ойн сан бүхий газар",
        "Авто зам - Бусад Бусад газар - Хилийн бүс",
        "Авто зам - Бусад Бусад газар - Гол, усны ай сав газар",
        "Авто зам - Бусад Олон нийтийн газар - амралтын газар",
        "Авто зам - Бусад Гэр, орон сууц - гэр",
        "Авто зам - Бусад Бусад газар - Намаржаа",
        "Авто зам - Бусад засвар, үйлчилгээний газар",
        "Авто зам - Бусад Гэр, орон сууц - бусад",
        "Авто зам - Бусад Нийтийн тээвэр - галт тэрэг",
        "Авто зам - Бусад Бусад газар - Ашиглаж байгаа уурхай",
        "Авто зам - Бусад Гэр, орон сууц - орон сууцны байр",
        "Авто зам - Бусад Гэр, орон сууц - гарааш",
        "Авто зам - Бусад Бусад газар - Баригдаж байгаа барилга",
        "Авто зам - Бусад Олон нийтийн газар - нисэх онгоцны буудал",
        "Авто зам - Бусад Бусад газар - Гадаад улсад",
        "Авто зам - Бусад Бусад газар - Ашигт малтмалын орд газар",
        "Авто зам - Бусад Нийтийн тээвэр - том оврын автобус",
        "Авто зам - Бусад Олон нийтийн газар - төмөр замын вокзал",
        "Авто зам - Бусад эмнэлэг төрийн өмчийн",
        "Авто зам - Бусад Төрийн бус байгууллага - бусад",
        "Авто зам - Бусад Нийтийн тээвэр - нисэх онгоц",
        "Авто зам - Бусад АТМ",
        "Авто зам - Замын хэсэг Уулзвар",
        "Авто зам - Замын хэсэг Бусад",
        "Авто зам - Замын хэсэг Гүүр",
        "Авто зам - Замын хэсэг Автобусны буудал",
        "Авто зам - Замын хэсэг Гарц",
        "Авто зам - Замын хэсэг Хонгил",
        "Авто зам - Замын хэсэг Төмөр замын гарам",
        "Авто зам - Замын хэсэг Зорчих хэсэг",
        "Авто зам - Замын хэсэг Тусгаарлах зурвас",
        "Авто зам - Замын хэсэг Түр зам",
        "Авто зам - Замын хэсэг Явган хүний зам дээр",
        "Авто зам - Замын хэсэг Сургууль орчимын зам",
        "Авто зам - Замын хэсэг Зогсоолын талбай",
        "Авто зам - Замын хэсэг Зорчих хэсгийн хөвөө",
        "Авто зам - Замын хэсэг Туслах зам",
        "Авто зам - Замын хэсэг Зам, барилгын ажлын талбай",
        "Авто зам - Ослын ноцтой байдал Хөнгөн гэмтэл авсан осол",
        "Авто зам - Ослын ноцтой байдал Хүнд, хүндэвтэр гэмтэл авсан осол",
        "Авто зам - Ослын ноцтой байдал Хүн нас барсан осол",
        "Авто зам - Ослын ноцтой байдал Эд материалын хохиролтой осол",
        "Авто зам - Ослын ноцтой байдал Гэмтэл бэртэл аваагүй осол",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам дээр саад байсан",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Гэрэл шилжүүлээгүй",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Хэт ядарсанаас",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Согтуугаар тээврийн хэрэгсэл жолоодсоноос",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Нойрмоглосоноос",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын нөхцөлөөс",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Гар утас хэрэглэж байснаас",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Буруу дохио, анхааруулга өгсөн",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын гадаргуу хальтиргаа, гулгаатай",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Сэтгэл зүйн байдлаас",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Дугуйн зам байхгүй байснаас",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам орчин хангалтгүй байсанаас",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Эрхэлсэн ажил мэргэжилээс",
        "Авто зам - Осолд нөлөөлөх хүчин зүйл Мансуурсанаас",
        "Авто зам - Ослын нөхцөл Хоёр тээврийн хэрэгсэл холбогдсон осол",
        "Авто зам - Ослын нөхцөл Нэг тээврийн хэрэгсэл холбогдсон осол",
        "Авто зам - Ослын нөхцөл Гурав бас түүнээс дээш тээврийн хэрэгсэл холбогдсон осол",
    ]
    df = df[columns].copy()
    df["Зөрчил огноо"] = pd.to_datetime(df["Зөрчил огноо"], errors="coerce")

    df["Year"] = df["Зөрчил огноо"].dt.year
    df["Month"] = df["Зөрчил огноо"].dt.month
    df["Day"] = df["Зөрчил огноо"].dt.day_name()
    print(df["Year"])
    # Handling missing values
    df["Зөрчил огноо жил 2022"] = (df["Year"] == 2022).astype(int)
    df["Зөрчил огноо жил 2023"] = (df["Year"] == 2023).astype(int)
    df["Зөрчил огноо жил 2024"] = (df["Year"] == 2024).astype(int)
    # Дөрвөн жилийн нийлбэр биш, харин логик флаг
    df["Зөрчил огноо жил 2022-2024"] = df["Year"].between(2022, 2024).astype(int)

    # Converting road width to numeric
    def clean_road_width(width):
        if pd.isna(width):
            return np.nan
        if isinstance(width, (int, float)):
            return float(width)
        if isinstance(width, str):
            # Remove units and specific Mongolian phrases
            width = (
                width.replace("м", "")
                .replace("-ээс дээш", "")
                .replace("хүртэл", "")
                .replace(",", ".")
                .strip()
            )
            # Handle ranges like "7.0-9.0"
            if "-" in width:
                try:
                    low, high = map(float, width.split("-"))
                    return (low + high) / 2
                except ValueError:
                    return np.nan
            # Handle single values like "3.5" or "3.5 хүртэл"
            try:
                return float(width)
            except ValueError:
                return np.nan
        return np.nan

    df["Авто зам - Зорчих хэсгийн өргөн"] = df["Авто зам - Зорчих хэсгийн өргөн"].apply(
        clean_road_width
    )
    return df


# Function to create correlation matrix


def plot_correlation_matrix(df, title, columns):
    # Сонгосон баганууд one-hot encoded эсэхийг шалгаж хэрэглэгчдэд анхааруулга өгөх
    n_unique = df[columns].nunique()
    if all((n_unique == 2) | (n_unique == 1)):
        st.warning(
            "Сонгосон баганууд нь нэг категори хувьсагчийн one-hot encoded хэлбэр байна. "
            "Ийм тохиолдолд корреляци нь 0 эсвэл -1 байж болохыг анхаарна уу."
        )

    df_encoded = df[columns].copy()
    for col in df_encoded.columns:
        if df_encoded[col].dtype == "object":
            df_encoded[col] = pd.Categorical(df_encoded[col]).codes

    corr_matrix = df_encoded.corr()

    # Мөрийг эсрэг дарааллаар эрэмбэлэх
    corr_matrix = corr_matrix.iloc[::-1]

    # Plotting heatmap
    fig, ax = plt.subplots(
        figsize=(max(8, 1.5 * len(columns)), max(6, 1.2 * len(columns)))
    )
    sns.heatmap(
        corr_matrix,
        annot=True,
        cmap="coolwarm",
        vmin=-1,
        vmax=1,
        center=0,
        ax=ax,
        fmt=".3f",
    )
    plt.title(title)
    plt.tight_layout()
    return fig


# Loading data
df = load_data()

# Streamlit app structure
st.title("Зам тээврийн ослуудын шинжилгээ (2022-2024)")

# ---------------------------------------
# 5. Ирээдүйн ослын таамаглал (ANN, NN, DL, ML олон модел)
# ---------------------------------------

st.header("5. Ирээдүйн ослын таамаглал (Олон ML/DL загвар)")
st.write("13 төрлийн ML/DL/ANN/NN моделийн таамаглалыг нэг дор үзүүлнэ.")


MODEL_LIST = [
    ("LinearRegression", LinearRegression()),
    ("Ridge", Ridge()),
    ("Lasso", Lasso()),
    ("DecisionTree", DecisionTreeRegressor()),
    ("RandomForest", RandomForestRegressor()),
    ("ExtraTrees", ExtraTreesRegressor()),
    ("GradientBoosting", GradientBoostingRegressor()),
    ("AdaBoost", AdaBoostRegressor()),
    ("KNeighbors", KNeighborsRegressor()),
    ("SVR", SVR()),
    ("MLPRegressor", MLPRegressor(hidden_layer_sizes=(64, 32), max_iter=1000)),
    ("XGBRegressor", XGBRegressor(verbosity=0)),
    ("CatBoostRegressor", CatBoostRegressor(verbose=0)),
]

# ----------- Өгөгдөл бэлтгэх -----------
forecast_col = "Осол"
grouped = df[df[forecast_col]==1].groupby(["Year", "Month"]).agg(osol_count=(forecast_col, "sum")).reset_index()
grouped["date"] = pd.to_datetime(grouped[["Year", "Month"]].assign(DAY=1))
weather_cols = [
    "Авто зам - Үзэгдэх орчин Чөлөөтэй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэлтүүлэггүй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэгтүүлэгтэй",
    "Авто зам - Үзэгдэх орчин Хязгаарлагдмал",
    "Авто зам - Үзэгдэх орчин Хангалтгүй",
    "Авто зам - Үзэгдэх орчин Бүрэнхий",
    "Авто зам - Үзэгдэх орчин Саад байсан",
    "Авто зам - Үзэгдэх орчин Манантай",
    "Авто зам - Цаг агаар Таатай",
    "Авто зам - Цаг агаар Үүлэрхэг",
    "Авто зам - Цаг агаар Цастай",
    "Авто зам - Цаг агаар Шуургатай",
    "Авто зам - Цаг агаар Манантай",
    "Авто зам - Цаг агаар Бороотой",
        "Авто зам - Замын онцлог Тэгш",
    "Авто зам - Замын онцлог Уруу",
    "Авто зам - Замын онцлог Өгсүүр",
    "Авто зам - Замын онцлог Шулуун",
    "Авто зам - Замын онцлог Хазгай",
    "Авто зам - Замын онцлог Огцом эргэлттэй",
    "Авто зам - Замын онцлог Налуу",
    "Авто зам - Замын онцлог Алсуур эргэлттэй",
        "Авто зам - Замын гадаргуу Хуурай",
    "Авто зам - Замын гадаргуу Мөстэй",
    "Авто зам - Замын гадаргуу Нойтон",
    "Авто зам - Замын гадаргуу Цастай",
    "Авто зам - Замын гадаргуу Эдрэлтэй",
    "Авто зам - Замын гадаргуу Бохирдсон",
    "Авто зам - Замын хэсэг Уулзвар",
    "Авто зам - Замын хэсэг Бусад",
    "Авто зам - Замын хэсэг Гүүр",
    "Авто зам - Замын хэсэг Автобусны буудал",
    "Авто зам - Замын хэсэг Гарц",
    "Авто зам - Замын хэсэг Хонгил",
    "Авто зам - Замын хэсэг Төмөр замын гарам",
    "Авто зам - Замын хэсэг Зорчих хэсэг",
    "Авто зам - Замын хэсэг Тусгаарлах зурвас",
    "Авто зам - Замын хэсэг Түр зам",
    "Авто зам - Замын хэсэг Явган хүний зам дээр",
    "Авто зам - Замын хэсэг Сургууль орчимын зам",
    "Авто зам - Замын хэсэг Зогсоолын талбай",
    "Авто зам - Замын хэсэг Зорчих хэсгийн хөвөө",
    "Авто зам - Замын хэсэг Туслах зам",
    "Авто зам - Замын хэсэг Зам, барилгын ажлын талбай",
     "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам дээр саад байсан",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гэрэл шилжүүлээгүй",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Хэт ядарсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Согтуугаар тээврийн хэрэгсэл жолоодсоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Нойрмоглосоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын нөхцөлөөс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гар утас хэрэглэж байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Буруу дохио, анхааруулга өгсөн",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын гадаргуу хальтиргаа, гулгаатай",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Сэтгэл зүйн байдлаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Дугуйн зам байхгүй байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам орчин хангалтгүй байсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Эрхэлсэн ажил мэргэжилээс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Мансуурсанаас",
    "Авто зам - Ослын нөхцөл Хоёр тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Нэг тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Гурав бас түүнээс дээш тээврийн хэрэгсэл холбогдсон осол",
]

# Сар бүр агрегатлах (sum хийх)
monthly_weather = df.groupby(['Year', 'Month'])[weather_cols].sum().reset_index()

# Үндсэн grouped датафреймтэй merge хийх (Year, Month-оор)
grouped = pd.merge(grouped, monthly_weather, on=['Year', 'Month'], how='left')

# Lag-уудыг үүсгэнэ
n_lag = 12
for i in range(1, n_lag+1):
    grouped[f"osol_lag_{i}"] = grouped["osol_count"].shift(i)
grouped = grouped.dropna().reset_index(drop=True)

# X, y matrix-д lag болон цаг агаарын хувьсагчдыг хамтад нь оруулна
X = grouped[[f"osol_lag_{i}" for i in range(1, n_lag+1)] + weather_cols].values
y = grouped["osol_count"].values.reshape(-1, 1)

# ---------- СКЭЙЛИНГ (ЗААВАЛ) ----------
scaler_X = MinMaxScaler()
scaler_y = MinMaxScaler()
X_scaled = scaler_X.fit_transform(X)
y_scaled = scaler_y.fit_transform(y)

# ---------- TRAIN/TEST ----------
train_size = int(len(X_scaled) * 0.8)
X_train, y_train = X_scaled[:train_size], y_scaled[:train_size].flatten()
X_test, y_test = X_scaled[train_size:], y_scaled[train_size:].flatten()

# --- Модел жагсаалт ---
MODEL_LIST = [
    ("LinearRegression", LinearRegression()),
    ("Ridge", Ridge()),
    ("Lasso", Lasso()),
    ("DecisionTree", DecisionTreeRegressor()),
    ("RandomForest", RandomForestRegressor()),
    ("ExtraTrees", ExtraTreesRegressor()),
    ("GradientBoosting", GradientBoostingRegressor()),
    ("AdaBoost", AdaBoostRegressor()),
    ("KNeighbors", KNeighborsRegressor()),
    ("SVR", SVR()),
    ("MLPRegressor", MLPRegressor(hidden_layer_sizes=(64, 32), max_iter=1000)),
    ("XGBRegressor", XGBRegressor(verbosity=0)),
    ("CatBoostRegressor", CatBoostRegressor(verbose=0)),
]

progress_bar = st.progress(0, text="ML моделийг сургаж байна...")

# ------- Олон моделийг сургах/таамаглах -------
results = []
y_preds = {}
for i, (name, model) in enumerate(MODEL_LIST):
    model.fit(X_train, y_train)
    y_pred = model.predict(X_test)
    y_preds[name] = y_pred
    mae = mean_absolute_error(y_test, y_pred)
    mse = mean_squared_error(y_test, y_pred)
    rmse = np.sqrt(mse)
    r2 = r2_score(y_test, y_pred)
    results.append({"Model": name, "MAE": mae, "RMSE": rmse, "R2": r2})
    progress = min(int((i+1) / len(MODEL_LIST) * 100), 100)
    progress_bar.progress(progress, text=f"{name} дууслаа")
progress_bar.empty()
st.success("Бүх ML модел сургагдлаа!")

# ----------- Метрик харуулах, Excel рүү татах -----------
results_df = pd.DataFrame(results)
st.dataframe(results_df)

excel_buffer = pd.ExcelWriter("model_metrics.xlsx", engine="xlsxwriter")
results_df.to_excel(excel_buffer, index=False)
excel_buffer.close()
with open("model_metrics.xlsx", "rb") as f:
    st.download_button(
        label="Моделийн метрик Excel татах",
        data=f,
        file_name="model_metrics.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

# ----------- Ирээдүйн 30, 90, 180, 365 хоногийн прогноз -----------
forecast_steps = {"30 хоног": 1, "90 хоног": 3, "180 хоног": 6, "365 хоног": 12}

def forecast_next(model, last_values, steps=12):
    preds = []
    input_seq = last_values.copy()
    for _ in range(steps):
        pred = model.predict([input_seq])[0]
        preds.append(pred)
        input_seq = np.roll(input_seq, -1)
        input_seq[-1] = pred
    return np.array(preds)

model_forecasts = {}
last_seq = X_scaled[-1]  # хамгийн сүүлийн 12 сар (scaled)

for name, model in MODEL_LIST:
    preds_dict = {}
    for k, s in forecast_steps.items():
        scaled_preds = forecast_next(model, last_seq, steps=s)
        # Inverse scale to real values
        # Бүх таамаглалыг scaler_y-р бодит утга руу хөрвүүлнэ
        inv_preds = scaler_y.inverse_transform(scaled_preds.reshape(-1, 1)).flatten()
        preds_dict[k] = inv_preds
    model_forecasts[name] = preds_dict

# --- 1. Test set дээрх бодит болон таамагласан ослын тоо (модел бүрээр) ---
test_dates = grouped["date"].iloc[-len(X_test):].values
test_true = scaler_y.inverse_transform(y_test.reshape(-1, 1)).flatten()  # inverse scale

test_preds_df = pd.DataFrame({'date': test_dates, 'real': test_true})
for name in MODEL_LIST:
    y_pred_inv = scaler_y.inverse_transform(y_preds[name[0]].reshape(-1, 1)).flatten()
    test_preds_df[name[0]] = y_pred_inv

# --- 2. Ирээдүйн forecast (12 сар) модель бүрээр ---
future_dates = pd.date_range(start=grouped["date"].iloc[-1]+pd.offsets.MonthBegin(), periods=12, freq="MS")
future_preds_df = pd.DataFrame({'date': future_dates})
for name, model in MODEL_LIST:
    scaled_preds = forecast_next(model, last_seq, steps=12)
    inv_preds = scaler_y.inverse_transform(scaled_preds.reshape(-1, 1)).flatten()
    future_preds_df[name] = inv_preds

# --- 3. Excel файлд export хийх (хоёр sheet-тэй: test болон ирээдүй) ---
with pd.ExcelWriter("model_predictions.xlsx", engine="xlsxwriter") as writer:
    test_preds_df.to_excel(writer, index=False, sheet_name="Test_Predictions")
    future_preds_df.to_excel(writer, index=False, sheet_name="Future_Predictions")

with open("model_predictions.xlsx", "rb") as f:
    st.download_button(
        label="Test/Forecast бүх моделийн таамаглалуудыг Excel-р татах",
        data=f,
        file_name="model_predictions.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

st.subheader("Test датан дээрх модел бүрийн бодит болон таамагласан утгууд:")
st.dataframe(test_preds_df.head(10))
st.subheader("Ирээдүйн 12 сарын прогноз (модел бүрээр):")
st.dataframe(future_preds_df)

# ----------- 1 жилийн прогноз график (модел сонгох) -----------
st.subheader("1 жилийн прогноз график (модел бүрээр):")
selected_model = st.selectbox("Модель сонгох:", list(model_forecasts.keys()))
future = model_forecasts[selected_model]["365 хоног"]
dates_future = pd.date_range(start=grouped["date"].iloc[-1]+pd.offsets.MonthBegin(), periods=12, freq="MS")
future_df = pd.DataFrame({"date": dates_future, "forecast": future})

import plotly.express as px
fig = px.line(future_df, x="date", y="forecast", markers=True, title=f"{selected_model}-ийн ирэх 12 сарын прогноз")
st.plotly_chart(fig, use_container_width=True)



# ----------- Газрын зураг дээр анхаарах байршил -----------

st.subheader("Анхаарах газрын байршил (Олон улсын онолын суурьтай кластерчилсан hotspot илрүүлэлт)")

# --- 1. Судалгааны тайлбар, онолын үндэслэл ---
st.markdown("""
**Spatial clustering/Hotspot analysis** нь олон улсын судалгаанд осол ихтэй бүс (black spot, hotspot)-ийг тодорхойлох хамгийн баталгаатай арга.  
- DBSCAN зэрэг алгоритм нь нэг дор ойрхон байрласан зөрчил, ослын бөөгнөрөл (spatial cluster)-ийг автоматаар тодруулдаг.
- Олон улсын ишлэл: Clark & Evans (1954), Anselin (1995), Hauer (1996).

**Энэхүү газрын зурагт:**
- Hotspot/кластер бүсийг DBSCAN-ээр илрүүлж, хотын хэмжээнд хамгийн их осолтой цэгүүдийг тодорхойлно.
- Аймаг бүрийн хамгийн аюултай (осол ихтэй) хар цэгийг мөн хамтад нь харуулна.
""")

# --- 2. Data preparation (last 12 months accidents only) ---
recent_df = df[
    (df["Зөрчил огноо"] >= (df["Зөрчил огноо"].max() - pd.DateOffset(months=12)))
    & (df[forecast_col] == 1)
].copy()
recent_df = recent_df.dropna(subset=["Өргөрөг", "Уртраг"]).copy()  # <--- NaN мөрүүдийг хасах

# --- 2. Data preparation: last 12 months + координат NaN хасна ---

# --- 3. DBSCAN spatial clustering for urban hotspots (100м радиус) ---
from sklearn.cluster import DBSCAN
import numpy as np

coords = recent_df[["Өргөрөг", "Уртраг"]].to_numpy()
kms_per_radian = 6371.0088
epsilon = 0.1 / kms_per_radian  # 0.1 км == 100м
if len(coords) >= 3:
    db = DBSCAN(eps=epsilon, min_samples=3, algorithm='ball_tree', metric='haversine').fit(np.radians(coords))
    recent_df["cluster"] = db.labels_
else:
    recent_df["cluster"] = -1  # insufficient data

# --- 4. Each cluster's central point and frequency ---
hotspots = (
    recent_df[recent_df["cluster"] != -1]
    .groupby("cluster")
    .agg(
        n_osol=("Осол", "sum"),
        lat=("Өргөрөг", "mean"),
        lon=("Уртраг", "mean"),
    )
    .sort_values("n_osol", ascending=False)
    .reset_index()
)

# --- 5. Аймаг бүрийн хамгийн их зөрчилтэй хар цэг (өргөн spatial scope) ---
if "Аймгийн нэр" in df.columns:
    aimag_top = (
        recent_df.groupby(["Аймгийн нэр", "Уртраг", "Өргөрөг"])
        .size().reset_index(name="count")
        .sort_values(["Аймгийн нэр", "count"], ascending=[True, False])
        .groupby("Аймгийн нэр").head(1)
    )
else:
    aimag_top = pd.DataFrame()

# --- 6. Газрын зураг үүсгэх ---
map_center_lat = hotspots["lat"].mean() if not hotspots.empty else 47
map_center_lon = hotspots["lon"].mean() if not hotspots.empty else 106
m = folium.Map(location=[map_center_lat, map_center_lon], zoom_start=6)

# --- Хотын кластерласан hotspot-уудыг том радиустайгаар дүрслэх (cluster/DBSCAN) ---
for _, row in hotspots.iterrows():
    folium.Circle(
        location=[row["lat"], row["lon"]],
        radius=120 + row["n_osol"] * 1,  # олон осолтой бүсийг томруулахаар
        color="orange",
        fill=True,
        fill_opacity=0.55,
        popup=folium.Popup(
            f"<b>Хотын hotspot кластер</b><br>Осол: <b>{int(row['n_osol'])}</b>",
            max_width=350,
        ),
    ).add_to(m)

# --- Аймаг бүрийн хар цэгүүдийг бага радиустай, цэнхэр өнгөөр харуулах ---
if not aimag_top.empty:
    for _, row in aimag_top.iterrows():
        count = int(row['count'])
        folium.Circle(
            location=[row["Өргөрөг"], row["Уртраг"]],
            radius=60 + count * 8,
            color="blue",
            fill=True,
            fill_opacity=0.45,
            popup=f"{row['Аймгийн нэр']} хар цэг<br>Осол: {count}"
        ).add_to(m)

    # Тайлбар (Legend) нэмэх
    folium.map.Marker(
        [map_center_lat + 1.3, map_center_lon],
        icon=folium.DivIcon(
            html=f"""<div style="font-size: 14pt; color: orange;">■ Хотын кластерласан hotspot</div>
                     <div style="font-size: 14pt; color: blue;">■ Аймаг бүрийн хар цэг</div>"""
        )
    ).add_to(m)

st_folium(m, width=1920, height=800)

# --- 7. Академик дүгнэлт, зөвлөмж хэсэг ---
st.markdown("""
#### Судалгааны дүгнэлт, зөвлөмж

- **Hotspot/кластер бүсүүд** нь хот дотор болон замын уулзвар, гол гудамжны ойролцоо төвлөрдөг нь олон улсын судалгааны үр дүнтэй тохирч байна (Clark & Evans, 1954; Hauer, 1996).
- **Аймаг бүрийн хар цэг** нь тухайн орон нутгийн захиргаа, замын бодлого төлөвлөлтөд зорилтот арга хэмжээ авах үндэслэл болдог.
- **Зөвлөмж:** Хотын болон аймаг, дүүргийн дээрх бүсүүдэд нарийвчилсан судалгаа, замын аюулгүй байдлын инженерийн болон менежментийн шийдлийг зорилтот байдлаар хэрэгжүүлэх шаардлагатай. 
""")



















st.header("1. Замын хөдөлгөөний ослуудын учир шалтгаанын тархалтын шинжилгээ")
st.write(
    "Зөрчлийн төрөл, замын нөхцөл, усад хувьсагчдын хоорондын корреляцийг судлана. Хамгийн ихдээ 15 хувьсагчыг сонгоно"
)

st.write("Санамж:")

st.write(
    "1. Year баганатай хамт one-hot багануудыг (2022, 2023, 2024) хамтад нь оруулахгүй."
)

st.write(
    "2. Корреляцад утга учиртай, өөр өөр агуулгатай хувьсагчууд оруул. Жишээ: Year, Авто зам - Замын хучилт Асфальт, анхаарал болгоомжгүй зөрчил, архидан согтуурсан зөрчил гэх мэт."
)

# ----------- ШИНЭ multiselect хэсэг -----------
vars_for_corr = [
    "Year",
    "Зөрчил огноо жил 2022",
    "Зөрчил огноо жил 2023",
    "Зөрчил огноо жил 2024",
    "Авто зам - Замын хучилт Тодорхойгүй",
    "Авто зам - Замын хучилт Асфальт",
    "Авто зам - Замын хучилт Бетон",
    "Авто зам - Замын хучилт Сайжруулсан",
    "Авто зам - Замын хучилт Хайрган",
    "Авто зам - Замын хучилт Хөрсөн",
    "Авто зам - Замын хучилт Цементэн",
    "Авто зам - Зорчих хэсгийн өргөн",
    "ГБХ: бусад зөрчил",
    "анхаарал болгоомжгүй зөрчил",
    "архидан согтуурсан зөрчил",
    "асран хамгаалагч зөрчил",
    "бусад зөрчил",
    "бэлдмэл хэрэглэсэн этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
    "бүрэн бус тээврийн хэрэгсэл жолоодсон зөрчил",
    "бүх шатны боловсролын/б-ын холбогдох албан тушаалтан 10 хүртэлх насны хүүхдийг харгалзах хүнгүйгээр ЗХ-д оролцуулсан зөрчил",
    "гадны гэрэл хэрэглэх зөрчил",
    "гарамгүй хэсгээр зам хөндлөн гарсан зөрчил",
    "гарц зөрчил",
    "гэрэл дохио зөрчсөн зөрчил",
    "гүйцэд түрүүлэх үйлдэл буруу зөрчил",
    "гүйцэж түрүүлэх үйлдэл буруу хийсэн зөрчил",
    "жолоодох чадваргүй үедээ зорчих хэсгээр явсан зөрчил",
    "жолоодох эрхээ хасуулсан этгээд эрхийн үнэмлэхгүй жолоодсон зөрчил",
    "зам: ЗХ-ний дүрмийг сахин биелүүлээгүй зөрчил",
    "зам: ЗХАБ-ыг хангаж чадахааргүй өвчтэй буюу ядарсан үедээ т/х жолоодож замын хөдөлгөөнд оролцсон зөрчил",
    "зам: ЗХАБ-ын эсрэг гэмт хэрэг зөрчил",
    "зам: Т/х жолоодох эрхгүй (жолоодлогын дадлага хийхээс бусад тохиолдолд) буюу эрхээ хасуулсан этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
    "зам: Эцэг эх зөрчил",
    "зам: гарц зөрчил",
    "зам: замын гэрэлтүүлэг хангалтгүй зөрчил",
    "зам: замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
    "зам: зогсолт зогсоолын журам зөрчсөн зөрчил",
    "зам: ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
    "зам: тэмдэг тэмдэглэл зөрчсөн зөрчил",
    "зам: явган хүний гарц ба гарамтай хэсгийн гарцгүй зөрчил",
    "замын гэрэлтүүлэг хангалтгүй зөрчил",
    "замын нөхцөлөөс зөрчил",
    "замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
    "зан харьцаа зөрчил",
    "зогсолт зогсоолын журам зөрчсөн зөрчил",
    "зогсоох арга хэмжээ аваагүй зөрчил",
    "зөрчлийн талаар холбогдох байгууллагад шуурхай мэдээлээгүй зөрчил",
    "мал хариулгагүй зөрчил",
    "нийтээр дагаж мөрдөх хэм хэмжээ зөрчсөн зөрчил",
    "ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
    "согтуугаар тээврийн хэрэгсэл жолоодсон зөрчил",
    "техникийн гэмтлээс замын нөхцөл байдлаас зөрчил",
    "уулзвар гарц нэвтрэх журам зөрчсөн зөрчил",
    "ухрах үйлдэл буруу хийсэн зөрчил",
    "хажуу хоорондын зай тохируулаагүй зөрчил",
    "хамгаалах бүс хэрэглээгүй зөрчил",
    "хувь хүний ёс суртахууны төлөвшил зөрчил",
    "хурд тохируулаагүй зөрчил",
    "хурд хэтрүүлсэн зөрчил",
    "хяналт шалгалт сул зөрчил",
    "хүн ба ачаа тээвэрлэх журам зөрчсөн зөрчил",
    "эвдэж сүйтгэсэн зөрчил",
    "эгнээ байр буруу эзэлсэн зөрчил",
    "эргэх үйлдэл буруу хийсэн зөрчил",
    "эрхийн үнэмлэхгүй этгээд тээврийн хэрэгсэл жолоодсон зөрчил",
    "эсрэг урсгалд орох зөрчил",
    "эсрэг урсгалд орсон зөрчил",
    "явган хүний гарц ба гарамтай хэсгийн гарцгүй хэсгээр гарсан зөрчил",
    "үүргээ зохих ёсоор биелүүлээгүй зөрчил",
    "өөрийгөө хянаж зөрчил",
    "Дүүрэг",
    "Аймаг",
    "Авто зам - Замын харьяалал Нийслэлийн чанартай авто зам",
    "Авто зам - Замын харьяалал Орон нутгийн чанартай авто зам",
    "Авто зам - Замын харьяалал Иргэн аж ахуйн нэгж, байгууллагын дотоодын зам",
    "Авто зам - Замын харьяалал Улсын чанартай авто зам",
    "Авто зам - Замын харьяалал Хувийн зам",
    "Авто зам - Замын харьяалал Олон улсын чанартай авто зам",
    "Авто зам - Замын харьяалал Тусгай зориулалтын зам",
    "Авто зам - Замын ангилал Хорооллын",
    "Авто зам - Замын ангилал Ердийн",
    "Авто зам - Замын ангилал Тууш",
    "Авто зам - Замын ангилал Хурдны",
    "Авто зам - Замын гадаргуу Хуурай",
    "Авто зам - Замын гадаргуу Мөстэй",
    "Авто зам - Замын гадаргуу Нойтон",
    "Авто зам - Замын гадаргуу Цастай",
    "Авто зам - Замын гадаргуу Эдрэлтэй",
    "Авто зам - Замын гадаргуу Бохирдсон",
    "Авто зам - Замын онцлог Тэгш",
    "Авто зам - Замын онцлог Уруу",
    "Авто зам - Замын онцлог Өгсүүр",
    "Авто зам - Замын онцлог Шулуун",
    "Авто зам - Замын онцлог Хазгай",
    "Авто зам - Замын онцлог Огцом эргэлттэй",
    "Авто зам - Замын онцлог Налуу",
    "Авто зам - Замын онцлог Алсуур эргэлттэй",
    "Авто зам - Үзэгдэх орчин Чөлөөтэй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэлтүүлэггүй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэгтүүлэгтэй",
    "Авто зам - Үзэгдэх орчин Хязгаарлагдмал",
    "Авто зам - Үзэгдэх орчин Хангалтгүй",
    "Авто зам - Үзэгдэх орчин Бүрэнхий",
    "Авто зам - Үзэгдэх орчин Саад байсан",
    "Авто зам - Үзэгдэх орчин Манантай",
    "Авто зам - Цаг агаар Таатай",
    "Авто зам - Цаг агаар Үүлэрхэг",
    "Авто зам - Цаг агаар Цастай",
    "Авто зам - Цаг агаар Шуургатай",
    "Авто зам - Цаг агаар Манантай",
    "Авто зам - Цаг агаар Бороотой",
    "Авто зам - Бусад Өдөр",
    "Авто зам - Бусад Суурин газар",
    "Авто зам - Бусад Шөнө",
    "Авто зам - Бусад Суурингийн гаднах",
    "Авто зам - Бусад Аж ахуйн нэгж - Бусад",
    "Авто зам - Бусад Гудамж талбай - бусад",
    "Авто зам - Бусад Бусад газар - Өвөлжөө",
    "Авто зам - Бусад Бусад газар - Хөдөө хээр",
    "Авто зам - Бусад Бусад газар - Бусад",
    "Авто зам - Бусад Гудамж талбай - ил зогсоол",
    "Авто зам - Бусад Гудамж талбай - төмөр зам",
    "Авто зам - Бусад Гудамж талбай - гэр хорооллын гудамж",
    "Авто зам - Бусад Олон нийтийн газар - бөөний худалдааны төв",
    "Авто зам - Бусад Олон нийтийн газар - бусад",
    "Авто зам - Бусад Гудамж талбай - автобусны буудал",
    "Авто зам - Бусад Гудамж талбай - орон сууцны хорооллын гудамж",
    "Авто зам - Бусад эмнэлэг хувийн өмчийн",
    "Авто зам - Бусад Бусад газар - Бэлчээр",
    "Авто зам - Бусад Олон нийтийн газар - авто вокзал",
    "Авто зам - Бусад Бусад газар - Хаваржаа",
    "Авто зам - Бусад Олон нийтийн газар - дэлгүүр",
    "Авто зам - Бусад шатахуун түгээх станц",
    "Авто зам - Бусад Гэр, орон сууц - хувийн байшин",
    "Авто зам - Бусад Бусад газар - Зуслан",
    "Авто зам - Бусад Бусад газар - Ойн сан бүхий газар",
    "Авто зам - Бусад Бусад газар - Хилийн бүс",
    "Авто зам - Бусад Бусад газар - Гол, усны ай сав газар",
    "Авто зам - Бусад Олон нийтийн газар - амралтын газар",
    "Авто зам - Бусад Гэр, орон сууц - гэр",
    "Авто зам - Бусад Бусад газар - Намаржаа",
    "Авто зам - Бусад засвар, үйлчилгээний газар",
    "Авто зам - Бусад Гэр, орон сууц - бусад",
    "Авто зам - Бусад Нийтийн тээвэр - галт тэрэг",
    "Авто зам - Бусад Бусад газар - Ашиглаж байгаа уурхай",
    "Авто зам - Бусад Гэр, орон сууц - орон сууцны байр",
    "Авто зам - Бусад Гэр, орон сууц - гарааш",
    "Авто зам - Бусад Бусад газар - Баригдаж байгаа барилга",
    "Авто зам - Бусад Олон нийтийн газар - нисэх онгоцны буудал",
    "Авто зам - Бусад Бусад газар - Гадаад улсад",
    "Авто зам - Бусад Бусад газар - Ашигт малтмалын орд газар",
    "Авто зам - Бусад Нийтийн тээвэр - том оврын автобус",
    "Авто зам - Бусад Олон нийтийн газар - төмөр замын вокзал",
    "Авто зам - Бусад эмнэлэг төрийн өмчийн",
    "Авто зам - Бусад Төрийн бус байгууллага - бусад",
    "Авто зам - Бусад Нийтийн тээвэр - нисэх онгоц",
    "Авто зам - Бусад АТМ",
    "Авто зам - Замын хэсэг Уулзвар",
    "Авто зам - Замын хэсэг Бусад",
    "Авто зам - Замын хэсэг Гүүр",
    "Авто зам - Замын хэсэг Автобусны буудал",
    "Авто зам - Замын хэсэг Гарц",
    "Авто зам - Замын хэсэг Хонгил",
    "Авто зам - Замын хэсэг Төмөр замын гарам",
    "Авто зам - Замын хэсэг Зорчих хэсэг",
    "Авто зам - Замын хэсэг Тусгаарлах зурвас",
    "Авто зам - Замын хэсэг Түр зам",
    "Авто зам - Замын хэсэг Явган хүний зам дээр",
    "Авто зам - Замын хэсэг Сургууль орчимын зам",
    "Авто зам - Замын хэсэг Зогсоолын талбай",
    "Авто зам - Замын хэсэг Зорчих хэсгийн хөвөө",
    "Авто зам - Замын хэсэг Туслах зам",
    "Авто зам - Замын хэсэг Зам, барилгын ажлын талбай",
    "Авто зам - Ослын ноцтой байдал Хөнгөн гэмтэл авсан осол",
    "Авто зам - Ослын ноцтой байдал Хүнд, хүндэвтэр гэмтэл авсан осол",
    "Авто зам - Ослын ноцтой байдал Хүн нас барсан осол",
    "Авто зам - Ослын ноцтой байдал Эд материалын хохиролтой осол",
    "Авто зам - Ослын ноцтой байдал Гэмтэл бэртэл аваагүй осол",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам дээр саад байсан",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гэрэл шилжүүлээгүй",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Хэт ядарсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Согтуугаар тээврийн хэрэгсэл жолоодсоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Нойрмоглосоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын нөхцөлөөс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гар утас хэрэглэж байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Буруу дохио, анхааруулга өгсөн",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын гадаргуу хальтиргаа, гулгаатай",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Сэтгэл зүйн байдлаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Дугуйн зам байхгүй байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам орчин хангалтгүй байсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Эрхэлсэн ажил мэргэжилээс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Мансуурсанаас",
    "Авто зам - Ослын нөхцөл Хоёр тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Нэг тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Гурав бас түүнээс дээш тээврийн хэрэгсэл холбогдсон осол",
]

# Хэрэглэгч өөрөө хувьсагч сонгоно
max_vars = 15
default_cols = vars_for_corr[:10]  # default 10-г харуулна
selected_cols = st.multiselect(
    f"Корреляцийн матрицад оруулах хувьсагчид:",
    vars_for_corr,
    default=default_cols,
    max_selections=max_vars,
)
if selected_cols:
    st.pyplot(plot_correlation_matrix(df, "Correlation Matrix", selected_cols))
else:
    st.warning("Сонгох хувьсагчидыг оруулна уу!")

st.header("2. Ослын өсөлтийн тренд")
st.subheader("Жил, сар бүрээр ослын тооны тренд")

# Ослын тоог жил, сарын түвшинд нэгтгэх
trend_data = (
    df[df["Осол"] == 1]
    .groupby(["Year", "Month"])
    .agg(osol_count=("Осол", "sum"))
    .reset_index()
)

# Графикийн шошго бэлдэх (жил-сарын формат, жишээ нь: "2022-01")
trend_data["YearMonth"] = trend_data.apply(
    lambda x: f"{int(x['Year'])}-{int(x['Month']):02d}", axis=1
)

# --- Жил сонгох хэсэг ---
available_years = sorted(trend_data['Year'].unique())
year_options = ["Бүгд"] + [str(y) for y in available_years]
selected_year = st.selectbox("Жил сонгох:", year_options)

# Сонгосон жилээр filter хийх
if selected_year != "Бүгд":
    trend_plot = trend_data[trend_data["Year"] == int(selected_year)].copy()
else:
    trend_plot = trend_data.copy()

# --- Plotly-гээр зурах ---
fig = px.line(
    trend_plot,
    x="YearMonth",
    y="osol_count",
    markers=True,
    labels={"YearMonth": "Он-Сар", "osol_count": "Ослын тоо"},
    title=""  # Дээр header байгаа тул энд хоосон
)
fig.update_layout(
    xaxis_tickangle=45,
    hovermode="x unified",
    plot_bgcolor="white",
    yaxis=dict(title="Ослын тоо", rangemode="tozero"),
    xaxis=dict(title="Он-Сар"),
)
fig.update_traces(line=dict(width=3, color="#1f77b4"))

st.write("Доорх графикт ослын тооны өөрчлөлтийг харуулав.")
st.plotly_chart(fig, use_container_width=True)



# --- 2. Comparison of Violations Across Districts and Provinces ---
# 2-р хэсэг: Хар цэг илрүүлэлт, анализ, газрын зураг
st.header("3. Осол их гардаг хар цэгийн байршлууд 2022-2024")
st.write(
    "Ослын байршлуудыг доорх газрын зургаар харуулав. Дүүрэгт 30 метр радиус, Аймагт 1000 метр радиус"
)
# Байршлын координат багана байгаа бол нэрийг нь оруулна уу!
coord_cols = ["Уртраг", "Өргөрөг"]
if not all(c in df.columns for c in coord_cols):
    st.error("Координатын баганууд (Уртраг, Өргөрөг) байх шаардлагатай!")
    st.stop()

# Бинар хувьсагчийн жагсаалтыг таны өгсөнчлөн тохируулна
binary_cols = [
    "Дугаар",
    "Авто зам - Замын хучилт Тодорхойгүй",
    "Авто зам - Замын хучилт Асфальт",
    "Авто зам - Замын хучилт Бетон",
    "Авто зам - Замын хучилт Сайжруулсан",
    "Авто зам - Замын хучилт Хайрган",
    "Авто зам - Замын хучилт Хөрсөн",
    "Авто зам - Замын хучилт Цементэн",
    "Авто зам - Зорчих хэсгийн өргөн",
    "ГБХ: бусад зөрчил",
    "анхаарал болгоомжгүй зөрчил",
    "архидан согтуурсан зөрчил",
    "асран хамгаалагч зөрчил",
    "бусад зөрчил",
    "бэлдмэл хэрэглэсэн этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
    "бүрэн бус тээврийн хэрэгсэл жолоодсон зөрчил",
    "бүх шатны боловсролын/б-ын холбогдох албан тушаалтан 10 хүртэлх насны хүүхдийг харгалзах хүнгүйгээр ЗХ-д оролцуулсан зөрчил",
    "гадны гэрэл хэрэглэх зөрчил",
    "гарамгүй хэсгээр зам хөндлөн гарсан зөрчил",
    "гарц зөрчил",
    "гэрэл дохио зөрчсөн зөрчил",
    "гүйцэд түрүүлэх үйлдэл буруу зөрчил",
    "гүйцэж түрүүлэх үйлдэл буруу хийсэн зөрчил",
    "жолоодох чадваргүй үедээ зорчих хэсгээр явсан зөрчил",
    "жолоодох эрхээ хасуулсан этгээд эрхийн үнэмлэхгүй жолоодсон зөрчил",
    "зам: ЗХ-ний дүрмийг сахин биелүүлээгүй зөрчил",
    "зам: ЗХАБ-ыг хангаж чадахааргүй өвчтэй буюу ядарсан үедээ т/х жолоодож замын хөдөлгөөнд оролцсон зөрчил",
    "зам: ЗХАБ-ын эсрэг гэмт хэрэг зөрчил",
    "зам: Т/х жолоодох эрхгүй (жолоодлогын дадлага хийхээс бусад тохиолдолд) буюу эрхээ хасуулсан этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
    "зам: Эцэг эх зөрчил",
    "зам: гарц зөрчил",
    "зам: замын гэрэлтүүлэг хангалтгүй зөрчил",
    "зам: замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
    "зам: зогсолт зогсоолын журам зөрчсөн зөрчил",
    "зам: ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
    "зам: тэмдэг тэмдэглэл зөрчсөн зөрчил",
    "зам: явган хүний гарц ба гарамтай хэсгийн гарцгүй зөрчил",
    "замын гэрэлтүүлэг хангалтгүй зөрчил",
    "замын нөхцөлөөс зөрчил",
    "замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
    "зан харьцаа зөрчил",
    "зогсолт зогсоолын журам зөрчсөн зөрчил",
    "зогсоох арга хэмжээ аваагүй зөрчил",
    "зөрчлийн талаар холбогдох байгууллагад шуурхай мэдээлээгүй зөрчил",
    "мал хариулгагүй зөрчил",
    "нийтээр дагаж мөрдөх хэм хэмжээ зөрчсөн зөрчил",
    "ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
    "согтуугаар тээврийн хэрэгсэл жолоодсон зөрчил",
    "техникийн гэмтлээс замын нөхцөл байдлаас зөрчил",
    "уулзвар гарц нэвтрэх журам зөрчсөн зөрчил",
    "ухрах үйлдэл буруу хийсэн зөрчил",
    "хажуу хоорондын зай тохируулаагүй зөрчил",
    "хамгаалах бүс хэрэглээгүй зөрчил",
    "хувь хүний ёс суртахууны төлөвшил зөрчил",
    "хурд тохируулаагүй зөрчил",
    "хурд хэтрүүлсэн зөрчил",
    "хяналт шалгалт сул зөрчил",
    "хүн ба ачаа тээвэрлэх журам зөрчсөн зөрчил",
    "эвдэж сүйтгэсэн зөрчил",
    "эгнээ байр буруу эзэлсэн зөрчил",
    "эргэх үйлдэл буруу хийсэн зөрчил",
    "эрхийн үнэмлэхгүй этгээд тээврийн хэрэгсэл жолоодсон зөрчил",
    "эсрэг урсгалд орох зөрчил",
    "эсрэг урсгалд орсон зөрчил",
    "явган хүний гарц ба гарамтай хэсгийн гарцгүй хэсгээр гарсан зөрчил",
    "үүргээ зохих ёсоор биелүүлээгүй зөрчил",
    "өөрийгөө хянаж зөрчил",
    "Дүүрэг",
    "Аймаг",
    "Авто зам - Замын харьяалал Нийслэлийн чанартай авто зам",
    "Авто зам - Замын харьяалал Орон нутгийн чанартай авто зам",
    "Авто зам - Замын харьяалал Иргэн аж ахуйн нэгж, байгууллагын дотоодын зам",
    "Авто зам - Замын харьяалал Улсын чанартай авто зам",
    "Авто зам - Замын харьяалал Хувийн зам",
    "Авто зам - Замын харьяалал Олон улсын чанартай авто зам",
    "Авто зам - Замын харьяалал Тусгай зориулалтын зам",
    "Авто зам - Замын ангилал Хорооллын",
    "Авто зам - Замын ангилал Ердийн",
    "Авто зам - Замын ангилал Тууш",
    "Авто зам - Замын ангилал Хурдны",
    "Авто зам - Замын гадаргуу Хуурай",
    "Авто зам - Замын гадаргуу Мөстэй",
    "Авто зам - Замын гадаргуу Нойтон",
    "Авто зам - Замын гадаргуу Цастай",
    "Авто зам - Замын гадаргуу Эдрэлтэй",
    "Авто зам - Замын гадаргуу Бохирдсон",
    "Авто зам - Замын онцлог Тэгш",
    "Авто зам - Замын онцлог Уруу",
    "Авто зам - Замын онцлог Өгсүүр",
    "Авто зам - Замын онцлог Шулуун",
    "Авто зам - Замын онцлог Хазгай",
    "Авто зам - Замын онцлог Огцом эргэлттэй",
    "Авто зам - Замын онцлог Налуу",
    "Авто зам - Замын онцлог Алсуур эргэлттэй",
    "Авто зам - Үзэгдэх орчин Чөлөөтэй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэлтүүлэггүй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэгтүүлэгтэй",
    "Авто зам - Үзэгдэх орчин Хязгаарлагдмал",
    "Авто зам - Үзэгдэх орчин Хангалтгүй",
    "Авто зам - Үзэгдэх орчин Бүрэнхий",
    "Авто зам - Үзэгдэх орчин Саад байсан",
    "Авто зам - Үзэгдэх орчин Манантай",
    "Авто зам - Цаг агаар Таатай",
    "Авто зам - Цаг агаар Үүлэрхэг",
    "Авто зам - Цаг агаар Цастай",
    "Авто зам - Цаг агаар Шуургатай",
    "Авто зам - Цаг агаар Манантай",
    "Авто зам - Цаг агаар Бороотой",
    "Авто зам - Бусад Өдөр",
    "Авто зам - Бусад Суурин газар",
    "Авто зам - Бусад Шөнө",
    "Авто зам - Бусад Суурингийн гаднах",
    "Авто зам - Бусад Аж ахуйн нэгж - Бусад",
    "Авто зам - Бусад Гудамж талбай - бусад",
    "Авто зам - Бусад Бусад газар - Өвөлжөө",
    "Авто зам - Бусад Бусад газар - Хөдөө хээр",
    "Авто зам - Бусад Бусад газар - Бусад",
    "Авто зам - Бусад Гудамж талбай - ил зогсоол",
    "Авто зам - Бусад Гудамж талбай - төмөр зам",
    "Авто зам - Бусад Гудамж талбай - гэр хорооллын гудамж",
    "Авто зам - Бусад Олон нийтийн газар - бөөний худалдааны төв",
    "Авто зам - Бусад Олон нийтийн газар - бусад",
    "Авто зам - Бусад Гудамж талбай - автобусны буудал",
    "Авто зам - Бусад Гудамж талбай - орон сууцны хорооллын гудамж",
    "Авто зам - Бусад эмнэлэг хувийн өмчийн",
    "Авто зам - Бусад Бусад газар - Бэлчээр",
    "Авто зам - Бусад Олон нийтийн газар - авто вокзал",
    "Авто зам - Бусад Бусад газар - Хаваржаа",
    "Авто зам - Бусад Олон нийтийн газар - дэлгүүр",
    "Авто зам - Бусад шатахуун түгээх станц",
    "Авто зам - Бусад Гэр, орон сууц - хувийн байшин",
    "Авто зам - Бусад Бусад газар - Зуслан",
    "Авто зам - Бусад Бусад газар - Ойн сан бүхий газар",
    "Авто зам - Бусад Бусад газар - Хилийн бүс",
    "Авто зам - Бусад Бусад газар - Гол, усны ай сав газар",
    "Авто зам - Бусад Олон нийтийн газар - амралтын газар",
    "Авто зам - Бусад Гэр, орон сууц - гэр",
    "Авто зам - Бусад Бусад газар - Намаржаа",
    "Авто зам - Бусад засвар, үйлчилгээний газар",
    "Авто зам - Бусад Гэр, орон сууц - бусад",
    "Авто зам - Бусад Нийтийн тээвэр - галт тэрэг",
    "Авто зам - Бусад Бусад газар - Ашиглаж байгаа уурхай",
    "Авто зам - Бусад Гэр, орон сууц - орон сууцны байр",
    "Авто зам - Бусад Гэр, орон сууц - гарааш",
    "Авто зам - Бусад Бусад газар - Баригдаж байгаа барилга",
    "Авто зам - Бусад Олон нийтийн газар - нисэх онгоцны буудал",
    "Авто зам - Бусад Бусад газар - Гадаад улсад",
    "Авто зам - Бусад Бусад газар - Ашигт малтмалын орд газар",
    "Авто зам - Бусад Нийтийн тээвэр - том оврын автобус",
    "Авто зам - Бусад Олон нийтийн газар - төмөр замын вокзал",
    "Авто зам - Бусад эмнэлэг төрийн өмчийн",
    "Авто зам - Бусад Төрийн бус байгууллага - бусад",
    "Авто зам - Бусад Нийтийн тээвэр - нисэх онгоц",
    "Авто зам - Бусад АТМ",
    "Авто зам - Замын хэсэг Уулзвар",
    "Авто зам - Замын хэсэг Бусад",
    "Авто зам - Замын хэсэг Гүүр",
    "Авто зам - Замын хэсэг Автобусны буудал",
    "Авто зам - Замын хэсэг Гарц",
    "Авто зам - Замын хэсэг Хонгил",
    "Авто зам - Замын хэсэг Төмөр замын гарам",
    "Авто зам - Замын хэсэг Зорчих хэсэг",
    "Авто зам - Замын хэсэг Тусгаарлах зурвас",
    "Авто зам - Замын хэсэг Түр зам",
    "Авто зам - Замын хэсэг Явган хүний зам дээр",
    "Авто зам - Замын хэсэг Сургууль орчимын зам",
    "Авто зам - Замын хэсэг Зогсоолын талбай",
    "Авто зам - Замын хэсэг Зорчих хэсгийн хөвөө",
    "Авто зам - Замын хэсэг Туслах зам",
    "Авто зам - Замын хэсэг Зам, барилгын ажлын талбай",
    "Авто зам - Ослын ноцтой байдал Хөнгөн гэмтэл авсан осол",
    "Авто зам - Ослын ноцтой байдал Хүнд, хүндэвтэр гэмтэл авсан осол",
    "Авто зам - Ослын ноцтой байдал Хүн нас барсан осол",
    "Авто зам - Ослын ноцтой байдал Эд материалын хохиролтой осол",
    "Авто зам - Ослын ноцтой байдал Гэмтэл бэртэл аваагүй осол",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам дээр саад байсан",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гэрэл шилжүүлээгүй",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Хэт ядарсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Согтуугаар тээврийн хэрэгсэл жолоодсоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Нойрмоглосоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын нөхцөлөөс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гар утас хэрэглэж байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Буруу дохио, анхааруулга өгсөн",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын гадаргуу хальтиргаа, гулгаатай",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Сэтгэл зүйн байдлаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Дугуйн зам байхгүй байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам орчин хангалтгүй байсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Эрхэлсэн ажил мэргэжилээс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Мансуурсанаас",
    "Авто зам - Ослын нөхцөл Хоёр тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Нэг тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Гурав бас түүнээс дээш тээврийн хэрэгсэл холбогдсон осол",
]
g = (
    df.groupby(["Уртраг", "Өргөрөг", "Дүүрэг", "Аймаг"])
    .agg(
        osol_count=("Осол", "sum"),
        dates=("Зөрчил огноо", lambda x: list(x)),
    )
    .reset_index()
)

district_hotspots = g[(g["Дүүрэг"] == 1) & (g["osol_count"] >= 3)].copy()
district_hotspots["radius"] = 30
province_hotspots = g[(g["Аймаг"] == 1) & (g["osol_count"] >= 2)].copy()
province_hotspots["radius"] = 1000

hotspots = pd.concat([district_hotspots, province_hotspots], ignore_index=True)


# Дундаж хоногийн зөрүү
def avg_days(dates):
    d = pd.Series(pd.to_datetime(dates)).sort_values()
    if len(d) > 1:
        days = d.diff().dt.total_seconds().dropna() / (3600 * 24)
        return np.round(days.mean(), 1)
    return np.nan


hotspots["avg_days"] = hotspots["dates"].apply(avg_days)

# Шалтгаан хувьсагч (numeric болгож mean тооцоолох)
cause_info = []
for i, row in hotspots.iterrows():
    filt = (
        (df["Уртраг"] == row["Уртраг"])
        & (df["Өргөрөг"] == row["Өргөрөг"])
        & (df["Осол"] == 1)
    )
    # Багануудыг numeric болгож алдааг засна
    local_df = df.loc[filt, binary_cols].apply(pd.to_numeric, errors="coerce")
    if len(local_df) > 0:
        vals = local_df.mean().sort_values(ascending=False).head(3)
        # Топ 3 хувьсагчийг зөв нэр, дунджаар форматлана
        top_causes = "; ".join([f"{idx}: {val:.2f}" for idx, val in vals.items()])
        cause_info.append(top_causes)
    else:
        cause_info.append("")
hotspots["Шалтгаан"] = cause_info

oslyn_dugaaruud = []
for i, row in hotspots.iterrows():
    filt = (
        (df["Уртраг"] == row["Уртраг"])
        & (df["Өргөрөг"] == row["Өргөрөг"])
        & (df["Осол"] == 1)
    )
    dugaaruud = df.loc[filt, "Дугаар"].dropna().astype(str).tolist()
    oslyn_dugaaruud.append(", ".join(dugaaruud) if dugaaruud else "Байхгүй")
hotspots["Ослыг дугаарууд"] = oslyn_dugaaruud







# Газрын зураг үүсгэх
if hotspots.empty:
    st.info("Хар цэг олдсонгүй.")
else:
    m = folium.Map(
        location=[hotspots["Өргөрөг"].mean(), hotspots["Уртраг"].mean()], zoom_start=12
    )
    for _, row in hotspots.iterrows():
        folium.Circle(
            location=[row["Өргөрөг"], row["Уртраг"]],
            radius=row["radius"],
            color="red" if row["radius"] == 30 else "blue",
            fill=True,
            fill_opacity=0.5,
            popup=folium.Popup(
                f"""Осол: {int(row["osol_count"])} <br>
                Дундаж хоногийн зай: {row["avg_days"]} <br>
                Шалтгаан: {row["Шалтгаан"]} <br>
                Ослыг дугаарууд: {row["Ослыг дугаарууд"]}
                """,
                max_width=400,
            ),
        ).add_to(m)
    st.subheader("Осол ихтэй хар цэгүүд")
    st_folium(m, width=1920, height=800)

    out = hotspots.copy()
    out["Зөрчил огноо"] = out["dates"].apply(
        lambda d: ", ".join(pd.Series(d).astype(str).tolist())
    )
    out = out[
        [
            "Уртраг",
            "Өргөрөг",
            "Дүүрэг",
            "Аймаг",
            "osol_count",
            "avg_days",
            "Шалтгаан",
            "Зөрчил огноо",
            "radius",
        ]
    ]
    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine="xlsxwriter") as writer:
        out.to_excel(writer, index=False, sheet_name="hotspots")
    buffer.seek(0)
    st.download_button(
        label="Хар цэгийн Excel татах",
        data=buffer,
        file_name="hotspots.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    )

categorical_cols = [
    "Авто зам - Замын хучилт Тодорхойгүй",
    "Авто зам - Замын хучилт Асфальт",
    "Авто зам - Замын хучилт Бетон",
    "Авто зам - Замын хучилт Сайжруулсан",
    "Авто зам - Замын хучилт Хайрган",
    "Авто зам - Замын хучилт Хөрсөн",
    "Авто зам - Замын хучилт Цементэн",
    "Авто зам - Зорчих хэсгийн өргөн",
    "ГБХ: бусад зөрчил",
    "анхаарал болгоомжгүй зөрчил",
    "архидан согтуурсан зөрчил",
    "асран хамгаалагч зөрчил",
    "бусад зөрчил",
    "бэлдмэл хэрэглэсэн этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
    "бүрэн бус тээврийн хэрэгсэл жолоодсон зөрчил",
    "бүх шатны боловсролын/б-ын холбогдох албан тушаалтан 10 хүртэлх насны хүүхдийг харгалзах хүнгүйгээр ЗХ-д оролцуулсан зөрчил",
    "гадны гэрэл хэрэглэх зөрчил",
    "гарамгүй хэсгээр зам хөндлөн гарсан зөрчил",
    "гарц зөрчил",
    "гэрэл дохио зөрчсөн зөрчил",
    "гүйцэд түрүүлэх үйлдэл буруу зөрчил",
    "гүйцэж түрүүлэх үйлдэл буруу хийсэн зөрчил",
    "жолоодох чадваргүй үедээ зорчих хэсгээр явсан зөрчил",
    "жолоодох эрхээ хасуулсан этгээд эрхийн үнэмлэхгүй жолоодсон зөрчил",
    "зам: ЗХ-ний дүрмийг сахин биелүүлээгүй зөрчил",
    "зам: ЗХАБ-ыг хангаж чадахааргүй өвчтэй буюу ядарсан үедээ т/х жолоодож замын хөдөлгөөнд оролцсон зөрчил",
    "зам: ЗХАБ-ын эсрэг гэмт хэрэг зөрчил",
    "зам: Т/х жолоодох эрхгүй (жолоодлогын дадлага хийхээс бусад тохиолдолд) буюу эрхээ хасуулсан этгээдэд т/х-ийн жолоог шилжүүлсэн зөрчил",
    "зам: Эцэг эх зөрчил",
    "зам: гарц зөрчил",
    "зам: замын гэрэлтүүлэг хангалтгүй зөрчил",
    "зам: замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
    "зам: зогсолт зогсоолын журам зөрчсөн зөрчил",
    "зам: ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
    "зам: тэмдэг тэмдэглэл зөрчсөн зөрчил",
    "зам: явган хүний гарц ба гарамтай хэсгийн гарцгүй зөрчил",
    "замын гэрэлтүүлэг хангалтгүй зөрчил",
    "замын нөхцөлөөс зөрчил",
    "замын тэмдэг тэмдэглэл байхгүй байсан зөрчил",
    "зан харьцаа зөрчил",
    "зогсолт зогсоолын журам зөрчсөн зөрчил",
    "зогсоох арга хэмжээ аваагүй зөрчил",
    "зөрчлийн талаар холбогдох байгууллагад шуурхай мэдээлээгүй зөрчил",
    "мал хариулгагүй зөрчил",
    "нийтээр дагаж мөрдөх хэм хэмжээ зөрчсөн зөрчил",
    "ойртон ирж яваа тээврийн хэрэгслийн урдуур гэнэт гүйсэн зөрчил",
    "согтуугаар тээврийн хэрэгсэл жолоодсон зөрчил",
    "техникийн гэмтлээс замын нөхцөл байдлаас зөрчил",
    "уулзвар гарц нэвтрэх журам зөрчсөн зөрчил",
    "ухрах үйлдэл буруу хийсэн зөрчил",
    "хажуу хоорондын зай тохируулаагүй зөрчил",
    "хамгаалах бүс хэрэглээгүй зөрчил",
    "хувь хүний ёс суртахууны төлөвшил зөрчил",
    "хурд тохируулаагүй зөрчил",
    "хурд хэтрүүлсэн зөрчил",
    "хяналт шалгалт сул зөрчил",
    "хүн ба ачаа тээвэрлэх журам зөрчсөн зөрчил",
    "эвдэж сүйтгэсэн зөрчил",
    "эгнээ байр буруу эзэлсэн зөрчил",
    "эргэх үйлдэл буруу хийсэн зөрчил",
    "эрхийн үнэмлэхгүй этгээд тээврийн хэрэгсэл жолоодсон зөрчил",
    "эсрэг урсгалд орох зөрчил",
    "эсрэг урсгалд орсон зөрчил",
    "явган хүний гарц ба гарамтай хэсгийн гарцгүй хэсгээр гарсан зөрчил",
    "үүргээ зохих ёсоор биелүүлээгүй зөрчил",
    "өөрийгөө хянаж зөрчил",
    "Дүүрэг",
    "Аймаг",
    "Авто зам - Замын харьяалал Нийслэлийн чанартай авто зам",
    "Авто зам - Замын харьяалал Орон нутгийн чанартай авто зам",
    "Авто зам - Замын харьяалал Иргэн аж ахуйн нэгж, байгууллагын дотоодын зам",
    "Авто зам - Замын харьяалал Улсын чанартай авто зам",
    "Авто зам - Замын харьяалал Хувийн зам",
    "Авто зам - Замын харьяалал Олон улсын чанартай авто зам",
    "Авто зам - Замын харьяалал Тусгай зориулалтын зам",
    "Авто зам - Замын ангилал Хорооллын",
    "Авто зам - Замын ангилал Ердийн",
    "Авто зам - Замын ангилал Тууш",
    "Авто зам - Замын ангилал Хурдны",
    "Авто зам - Замын гадаргуу Хуурай",
    "Авто зам - Замын гадаргуу Мөстэй",
    "Авто зам - Замын гадаргуу Нойтон",
    "Авто зам - Замын гадаргуу Цастай",
    "Авто зам - Замын гадаргуу Эдрэлтэй",
    "Авто зам - Замын гадаргуу Бохирдсон",
    "Авто зам - Замын онцлог Тэгш",
    "Авто зам - Замын онцлог Уруу",
    "Авто зам - Замын онцлог Өгсүүр",
    "Авто зам - Замын онцлог Шулуун",
    "Авто зам - Замын онцлог Хазгай",
    "Авто зам - Замын онцлог Огцом эргэлттэй",
    "Авто зам - Замын онцлог Налуу",
    "Авто зам - Замын онцлог Алсуур эргэлттэй",
    "Авто зам - Үзэгдэх орчин Чөлөөтэй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэлтүүлэггүй",
    "Авто зам - Үзэгдэх орчин Зорчих хэсэг гэрэгтүүлэгтэй",
    "Авто зам - Үзэгдэх орчин Хязгаарлагдмал",
    "Авто зам - Үзэгдэх орчин Хангалтгүй",
    "Авто зам - Үзэгдэх орчин Бүрэнхий",
    "Авто зам - Үзэгдэх орчин Саад байсан",
    "Авто зам - Үзэгдэх орчин Манантай",
    "Авто зам - Цаг агаар Таатай",
    "Авто зам - Цаг агаар Үүлэрхэг",
    "Авто зам - Цаг агаар Цастай",
    "Авто зам - Цаг агаар Шуургатай",
    "Авто зам - Цаг агаар Манантай",
    "Авто зам - Цаг агаар Бороотой",
    "Авто зам - Бусад Өдөр",
    "Авто зам - Бусад Суурин газар",
    "Авто зам - Бусад Шөнө",
    "Авто зам - Бусад Суурингийн гаднах",
    "Авто зам - Бусад Аж ахуйн нэгж - Бусад",
    "Авто зам - Бусад Гудамж талбай - бусад",
    "Авто зам - Бусад Бусад газар - Өвөлжөө",
    "Авто зам - Бусад Бусад газар - Хөдөө хээр",
    "Авто зам - Бусад Бусад газар - Бусад",
    "Авто зам - Бусад Гудамж талбай - ил зогсоол",
    "Авто зам - Бусад Гудамж талбай - төмөр зам",
    "Авто зам - Бусад Гудамж талбай - гэр хорооллын гудамж",
    "Авто зам - Бусад Олон нийтийн газар - бөөний худалдааны төв",
    "Авто зам - Бусад Олон нийтийн газар - бусад",
    "Авто зам - Бусад Гудамж талбай - автобусны буудал",
    "Авто зам - Бусад Гудамж талбай - орон сууцны хорооллын гудамж",
    "Авто зам - Бусад эмнэлэг хувийн өмчийн",
    "Авто зам - Бусад Бусад газар - Бэлчээр",
    "Авто зам - Бусад Олон нийтийн газар - авто вокзал",
    "Авто зам - Бусад Бусад газар - Хаваржаа",
    "Авто зам - Бусад Олон нийтийн газар - дэлгүүр",
    "Авто зам - Бусад шатахуун түгээх станц",
    "Авто зам - Бусад Гэр, орон сууц - хувийн байшин",
    "Авто зам - Бусад Бусад газар - Зуслан",
    "Авто зам - Бусад Бусад газар - Ойн сан бүхий газар",
    "Авто зам - Бусад Бусад газар - Хилийн бүс",
    "Авто зам - Бусад Бусад газар - Гол, усны ай сав газар",
    "Авто зам - Бусад Олон нийтийн газар - амралтын газар",
    "Авто зам - Бусад Гэр, орон сууц - гэр",
    "Авто зам - Бусад Бусад газар - Намаржаа",
    "Авто зам - Бусад засвар, үйлчилгээний газар",
    "Авто зам - Бусад Гэр, орон сууц - бусад",
    "Авто зам - Бусад Нийтийн тээвэр - галт тэрэг",
    "Авто зам - Бусад Бусад газар - Ашиглаж байгаа уурхай",
    "Авто зам - Бусад Гэр, орон сууц - орон сууцны байр",
    "Авто зам - Бусад Гэр, орон сууц - гарааш",
    "Авто зам - Бусад Бусад газар - Баригдаж байгаа барилга",
    "Авто зам - Бусад Олон нийтийн газар - нисэх онгоцны буудал",
    "Авто зам - Бусад Бусад газар - Гадаад улсад",
    "Авто зам - Бусад Бусад газар - Ашигт малтмалын орд газар",
    "Авто зам - Бусад Нийтийн тээвэр - том оврын автобус",
    "Авто зам - Бусад Олон нийтийн газар - төмөр замын вокзал",
    "Авто зам - Бусад эмнэлэг төрийн өмчийн",
    "Авто зам - Бусад Төрийн бус байгууллага - бусад",
    "Авто зам - Бусад Нийтийн тээвэр - нисэх онгоц",
    "Авто зам - Бусад АТМ",
    "Авто зам - Замын хэсэг Уулзвар",
    "Авто зам - Замын хэсэг Бусад",
    "Авто зам - Замын хэсэг Гүүр",
    "Авто зам - Замын хэсэг Автобусны буудал",
    "Авто зам - Замын хэсэг Гарц",
    "Авто зам - Замын хэсэг Хонгил",
    "Авто зам - Замын хэсэг Төмөр замын гарам",
    "Авто зам - Замын хэсэг Зорчих хэсэг",
    "Авто зам - Замын хэсэг Тусгаарлах зурвас",
    "Авто зам - Замын хэсэг Түр зам",
    "Авто зам - Замын хэсэг Явган хүний зам дээр",
    "Авто зам - Замын хэсэг Сургууль орчимын зам",
    "Авто зам - Замын хэсэг Зогсоолын талбай",
    "Авто зам - Замын хэсэг Зорчих хэсгийн хөвөө",
    "Авто зам - Замын хэсэг Туслах зам",
    "Авто зам - Замын хэсэг Зам, барилгын ажлын талбай",
    "Авто зам - Ослын ноцтой байдал Хөнгөн гэмтэл авсан осол",
    "Авто зам - Ослын ноцтой байдал Хүнд, хүндэвтэр гэмтэл авсан осол",
    "Авто зам - Ослын ноцтой байдал Хүн нас барсан осол",
    "Авто зам - Ослын ноцтой байдал Эд материалын хохиролтой осол",
    "Авто зам - Ослын ноцтой байдал Гэмтэл бэртэл аваагүй осол",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам дээр саад байсан",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гэрэл шилжүүлээгүй",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Хэт ядарсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Согтуугаар тээврийн хэрэгсэл жолоодсоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Нойрмоглосоноос",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын нөхцөлөөс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Гар утас хэрэглэж байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Буруу дохио, анхааруулга өгсөн",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Замын гадаргуу хальтиргаа, гулгаатай",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Сэтгэл зүйн байдлаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Дугуйн зам байхгүй байснаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Зам орчин хангалтгүй байсанаас",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Эрхэлсэн ажил мэргэжилээс",
    "Авто зам - Осолд нөлөөлөх хүчин зүйл Мансуурсанаас",
    "Авто зам - Ослын нөхцөл Хоёр тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Нэг тээврийн хэрэгсэл холбогдсон осол",
    "Авто зам - Ослын нөхцөл Гурав бас түүнээс дээш тээврийн хэрэгсэл холбогдсон осол",
]

st.header("4. Категори хувьсагчдын хоорондын хамаарал (Cramér’s V болон Chi-square)")


st.write("Тайлбар:")
st.write(
    "1-р категори хувьсагч, 2-р категори хувьсагч - Сонгох UI дээр categorical хувьсагчдаас 2-ыг сонгоно."
)
st.write("Chi-square: p-value бага бол (ихэвчлэн <0.05) хамааралтай гэж үзнэ.")
st.write(
    "Cramér’s V: 0-д ойрхон бол бараг хамааралгүй, 1-д ойр бол хүчтэй хамааралтай."
)
st.write("Crosstab (frequency table) – тухайн хувьсагчдын давтамжийг харуулна.")


var1 = st.selectbox("1-р категори хувьсагч:", categorical_cols)
var2 = st.selectbox(
    "2-р категори хувьсагч:", [c for c in categorical_cols if c != var1]
)


from scipy.stats import chi2_contingency

if var1 and var2:
    table = pd.crosstab(df[var1], df[var2])

    # Chi-square
    chi2, p, dof, expected = chi2_contingency(table)

    # Cramér’s V
    n = table.values.sum()
    r, k = table.shape
    cramers_v = np.sqrt(chi2 / (n * (min(k, r) - 1))) if min(k, r) > 1 else np.nan

    st.subheader("1. Chi-square тест")
    st.write("Категори (чанарын) өгөгдөл хоорондоо хамааралтай эсэхийг шалгадаг статистикийн тест.Жишээ: Хүйс (эрэгтэй/эмэгтэй) болон Тамхи татдаг эсэх (тийм/үгүй) хоёр хувьсагч хооронд хамаарал байна уу гэдгийг мэдэх. p-value < 0.05 бол хамааралтай гэж үздэг (өөрөөр хэлбэл, санамсаргүй тохиолдол биш)")

    st.write(f"**Chi-square statistic:** {chi2:.3f}")
    st.write(f"**p-value:** {p:.4f}")
    if p < 0.05:
        st.success("p < 0.05 → Статистикийн хувьд хамааралтай!")
    else:
        st.info("p ≥ 0.05 → Статистикийн хувьд хамааралгүй.")

    st.subheader("2. Cramér’s V")

    st.write("Chi-square тестийн гарсан үр дүнг 0-ээс 1 хүртэл хэмжигдэх “хүчтэй эсэх” буюу хамаарлын хүчийг хэмждэг коэффициент.Chi-square тестээр хамаарал байна гэж гарсан бол яг хичнээн хүчтэй хамаарал вэ? гэдгийг хардаг. 0 бол хамаарал байхгүй, 1 бол маш хүчтэй хамаарал.")
    st.write(f"**Cramér’s V:** {cramers_v:.3f} (0=хамааралгүй, 1=хүчтэй хамаарал)")
    if cramers_v < 0.1:
        st.info("Бараг хамааралгүй. (Сул хамаарлаас доогуур)")
    elif cramers_v < 0.3:
        st.info("Сул хамааралтай")
    elif cramers_v < 0.5:
        st.info("Дунд зэрэг хамааралтай")
    else:
        st.success("Их хамааралтай")
    st.write("**Crosstab:**")
    st.dataframe(table)
